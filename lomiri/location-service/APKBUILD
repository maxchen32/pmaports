# Maintainer: Luca Weiss <luca@z3ntu.xyz>
# Contributor: Bart Ribbers <bribbers@disroot.org>
# Contributor: Antoni Aloy <aaloytorrens@gmail.com>
pkgname=location-service
pkgver=0_git20220620
pkgrel=0
_commit="aed184f49a7bb5df5fcaa0c8522d97702e65ff68"
pkgdesc="Location service aggregating position/velocity/heading updates and exporting them over dbus"
arch="all"
url="https://gitlab.com/ubports/development/core/location-service"
license="GPL-3.0 LGPL-3.0"
depends_dev="boost-dev dbus-dev net-cpp-dev process-cpp-dev properties-cpp-dev json-c-dev libapparmor-dev gflags-dev glog-dev trust-store-dev"
makedepends="$depends_dev cmake-extras gettext gtest-dev gmock dbus-cpp-dev"
checkdepends="coreutils"
source="
	https://gitlab.com/ubports/development/core/location-service/-/archive/$_commit/location-service-$_commit.tar.gz
	0001-Fix-lsb_release-if-expression-failing-with-empty-out.patch
	0002-Add-missing-header-include.patch
	0003-Add-missing-string-header.patch
	0004-Add-missing-header-for-boost.patch
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Several failures

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DLOCATION_SERVICE_ENABLE_GPS_PROVIDER=OFF
	cmake --build build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
fff27ae4c27f9acc1e83abbd41d5ea94c5ba2f1b3dd063bd088fe2b372d8ba6efbedc3ae37b5687db48350e936a1261f78fb75578c31a0252d194422a01b7862  location-service-aed184f49a7bb5df5fcaa0c8522d97702e65ff68.tar.gz
e21b3249cb65c279122cb5cf0920148251e172094ecd644927e8994e0a714c7e5a9f8e8692fd6c58424ba7b1550a8901b0fc5fd5c7d5b58037c8943ee6038d0f  0001-Fix-lsb_release-if-expression-failing-with-empty-out.patch
2ddaa754deaea80fede016750f33f1d19f09c73f128d4212e0331c223fae06fad75b9e880888bc19920bb210cb885a2b1b3fbede68593b8df06a9cfc2cf5eb61  0002-Add-missing-header-include.patch
b59f147113be320be5b7363948b2fc3d4f9346ea07dc363a19a3c20114c6f23e2fe6d60ae62a58ca5c5058d434c3923d05965c09f1ce71b49e0d3c39ea5018c4  0003-Add-missing-string-header.patch
edb665cd4acf81bb3f2ab24d5df460688e18d4f13a17129e50f69648e54a92083e2585c2c07e73b6bb2bbc64b6a1e4519b6bc16e9cd342eadd737e2b62e77167  0004-Add-missing-header-for-boost.patch
"
