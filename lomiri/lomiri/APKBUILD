# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20220531
_commit="11f29d3ab1615e36ffb5d2e1efb2f394cc5a3500"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/development/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components lomiri-schemas suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor lomiri-keyboard"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock lomiri-indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev elogind-dev qtmir-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/development/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	0005-No-systemd.patch
	0006-fixups.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel.1/
}

sha512sums="
5995e5adfd71a6647b1c9788a8cb1326a036a53e5ea19b49e7df6ff57a089dd37bb82aedc91836c9d41bae2410da17b24a4a4873abf415ddcc297c7990b6d3e9  lomiri-11f29d3ab1615e36ffb5d2e1efb2f394cc5a3500.tar.gz
628382be3a6679511abf2d3517c8b65ff212a2639fcaf5b695b5e030bc7ba6f78eb3c30754b78079d63a8280d43da09ddebad69bc941909c13ac28b7b88ea858  0001-NoDpkgParse.patch
dca700689aa4b8abeb8280bea160b42c63ff86aefce73257b3ca3847d05217c92707fe85863292e77ddaf8d9bb9056c8959c3f2ada6802d633860109260c64ce  0002-Add-missing-includes.patch
e795172037595cd70555550263a5128bb24b93e2be0bd9c3aa098dddc85ff724c26f8407d30ca1eaa435f2797b5e1a402848fd1745cbc722f3c83247190cd999  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
b4d4e422de0297a9eb04550d54afa7a5bc945460d910c6bc212343d3ed792f555627593f26338c4db558bfa9018f683cee226581c4709f257884c5b70454e668  0004-Link-against-libintl.patch
9250a3f652299300950dcaa16350e7dc40cba673a13da746e9ccae44b7a8bd9043a82bd1db78d656c3a7915c07bcff46a3d22bacf1d83e1fa9ff3c8ddfeb6d47  0005-No-systemd.patch
eccb0d31fe9e88a9e04ffb1a2239abd0d561586090e9824a1c419461e3b6d69c6b2342ff6bc3242bd881c9fb7ac4ea9cb4317394b0c4aff88d379df45037a7da  0006-fixups.patch
"
